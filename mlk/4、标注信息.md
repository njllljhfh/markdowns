# 标注信息

### 一、保存标注信息接口

```
API名称： 保存标注信息接口
描述：将单张图片的标注信息保存
数据格式：JSON
方法：AJAX POST
是否需要用户授权：否
请求URL：http://[ip]:8000/labels/info
```

#### 1、请求格式

> 保存标注信息的时候，保存的报文格式随着【任务类型】而改变，现在支持的任务类型为两类：
> ​	分类(1)--暂不支持、分割(2)、检测(3)

###### 1.1 请求报文格式

```json
{
    "task_id":"2018062010000026348",		# [1]任务ID，19位字符串
    "task_type":2,							# [2]任务类型
    "img_id":"2018062010000000001",		   	# [3]图片ID，19位字符串
    "img_name":"xxx.jpg",					# [4]图片名字
    "oper_id":"2018031452354620523",		# [5]操作人ID，即用户ID，8+11位，后面加的功能
    "class_list":[					   		# [6]标签类列表
    	{ 	
    		"id":12,			  		  	# [7]标签类ID
    		"name":"xxx",		  		  	# [8]标签类名
    		"color":"#445566",	 	   		# [9]标签类颜色，十六进制
    		"order_id":1,				  	# [10]标签类序号，（可以不传，按顺序给就行）
        },
    ],
	"instance_list":[						# [11]实例列表
        {
            "class_id":12,					# [12]标签类ID
            "order_id":1,					# [13]实例序号，（可以不传，按顺序给就行）
            "name":"XXXX",					# [14]实例名
            "desc":"",						# 标注实例的描述！！
            # "bbox":[x,y,w,h],				# bounding box，待确认，和mask一起
            "properties":[					# [15]属性列表
                {
                    "name":"xxxx",			# [16]属性名称
                    "value":"xxxx",			# [17]属性值
                },
    		],
			"labels":["svg_1","svg_3"]		# [18]label_list标签列表svg的attr中的id
		},
    ],
    "label_list":[					# [19]标签列表
		{
            "element": "rect",  # [19]svg类型，4个值 rect、ellipse、path、line
            "attr": {   	    # [20]svg属性，不同类型的键值对不一样
                "x": 120,
                "y": 120,
                "width": 200,
                "height": 200,
                "stroke": "#f00",
                "stroke-width": "1.5",
                "id": "svg_2",
                "opacity": 1,
                "fill": "none",
                "style": "pointer-events:none"
            }
        },
    ]
}
```

###### 1.2 规则注释

```json
# 规则注释
[1]：任务ID，19位，字符串类型
[2]：任务类型，很重要，决定报文传输格式； # 分类(1)--暂不支持、分割(2)、检测(3)
[15]：属性列表，根据任务类型不同，当不存在属性列表的时候，传 null 或 不传
[18]：标签类列表，值为label_list中每个元素的order_id，不管是不是label组合，都要传列表格式

# 为了避免无数据时出错，[6]标签类列表、[11]实例列表、[19]标签列表，在没有数据时，赋值[]空列表；如果传null或不传该字段会报错
```

#### 2、响应格式

```json
{
    "code": 0,		# 表示成功
    "msg": "OK",	# 提示信息
}
```

#### 3、前端逻辑

```json
# 前提
前端拿到了每张图片的 { img_name:img_id } 的 Map
# 前端触发保存的逻辑
前端设定一个全局变量switch开关，当当前选中图片标注信息修改之后，switch打开，切换图片的时候才会触发保存标注的信息；否则切换图片的时候，不保存标注。
```



### 二、获取标注信息接口

> 更新：20181108
> 现在没有图片级别的热力图了，只有class级别的热力图，所以改变返回报文的格式

```
API名称：获取标注信息接口
描述：获取单张图片的标注信息
数据格式：JSON
方法：AJAX GET
是否需要用户授权：否
请求URL：http://[ip]:8000/labels/info
```

#### 1、前端请求格式

###### 1.1请求报文格式

```json
URL请求：http://[ip]:8000/labels/info?type=<type>&iid=<iid>
# 参数
type:task_type, # 分类(1)--暂不支持、分割(2)、检测(3)
iid:img_id，图片ID，19位
```

#### 2、响应格式

```json
{
	"code":0,	# 返回成功时
    "msg":"OK",
    "class_list":[						# 前端加载了class，属性不用给
    	{ 	
    		"id":12,			  		# 标签类ID
    		"name":"xxx",		  		# 标签类名
    		"color":"#778899",			# 标签类颜色,十六进制
    		"order_id":1,				# 标签类序号，（可以不传，按顺序给就行）
        },
		# 第二个标签类
    ],
    "instance_list":[
	    {
            "class_id":12,					# 标签类ID
            "order_id":1,
            "name":"XXXX",					# 实例名字，(如果是dl生成的，命名为dl_1)
            "desc":"",						# 标注实例的描述！！
            # "bbox":[x,y,w,h],
            "properties":[					# 属性列表
                {
                    "name":"xxxx",			# 属性名称
                    "value":"xxxx",			# 属性值
                },
    		],
            "labels":["svg_1","svg_3"]		# [18]label_list标签列表svg的attr中的id
         },
         # 第二个实例信息
    ],
	"label_list":[
		{
            "element": "rect",  # svg类型，4个值 rect、ellipse、path、line
            "attr": {   	    # svg属性，不同类型的键值对不一样
                "x": 120,
                "y": 120,
                "width": 200,
                "height": 200,
                "stroke": "#f00",
                "stroke-width": "1.5",
                "id": "svg_2",
                "opacity": 1,
                "fill": "none",
                "style": "pointer-events:none"
            }
        },
        # 第二个svg的json格式
        # dl预测的实例格式如下
        {
            "element": "rect",  # svg类型，4个值 rect、ellipse、path、line
            "attr": {   	    # svg属性，不同类型的键值对不一样
                "x": 120,
                "y": 120,
                "width": 200,
                "height": 200,
                "stroke": "#f00",
                "stroke-width": "1.5",
                "id": "svg_dl_2",		# dl预测的实例这么展示
                "opacity": 1,
                "fill": "none",
                "style": "pointer-events:none"
            }
        },
    ],
	"is_dl":false,
	# 判断以下字段,区分是热力图格式，还是预测实例格式
	"predict_type": "heatchart",	# DL预测数据的类型，"heatchart" or "instance"
	# 检测任务判断以下字段
    "scores":{						# 预测实例概率值，键key为label_list的id
		"svg_dl_1": 0.94,
        "svg_dl_2": 0.89
    }
}
```

3、前端实现逻辑

```json
# 备注：检测任务才会有预测概率值score；分割任务才会有热力图

先判断is_dl，查看是否是DL处理过的，如果是，查看predict_type预测数据类型；
根据类型判断是 热力图 还是 标注实例

# "heatcharts"这个字段不再给了，根据heatchart_type，自己组链接请求，链接类似
"http://接口"+"?img=<img_id>&c=<class_name>"，详见对应接口
```



#### 3、后端及前端实现

```json
dl预测的svg命名方式：svg_dl_{num}

分割类型的模型，保存热力图的数据结构：
{
    "heatchart_type":"class",		# 热力图格式，class or image
    "map_heatchart":{
    	"class_name": mask_mongo_id
	}
}
如果为image类型，则 map_heatchart中的键为 "image"

# 20181108现在没有图片级别的热力图了，只有class级别的热力图，所以改变返回报文的格式
```



